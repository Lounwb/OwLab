# OwLab 需求分析文档

## 1. 项目概述

OwLab 是一个基于 SwanLab 和飞书的 Python 工具库，用于机器学习实验的全生命周期管理，包括实验配置、追踪、管理以及消息通知和实验数据管理。

### 1.1 项目目标

- 提供统一的实验管理接口，简化机器学习实验流程
- 集成 SwanLab 进行实验追踪和可视化
- 集成飞书机器人进行消息通知和实验数据管理
- 支持本地和云端双重存储，确保数据安全

### 1.2 目标用户

- 机器学习研究人员
- 数据科学家
- 需要管理多个实验的团队

## 2. 功能需求

### 2.1 飞书机器人消息通知和实验数据管理

#### 2.1.1 Webhook Bot 功能

**需求描述：**
- 负责实验开始和实验结束的消息通知
- 消息通知需要包含以下信息：
  - 实验名称
  - 实验描述
  - 实验配置
  - 实验结果
  - SwanLab 的实验地址
  - 实验数据保存的飞书文件夹地址

**配置要求：**
- 需要提供 `webhook_url` 配置
- 需要提供 `signature` 配置（用于消息签名验证）

**消息格式：**
- 实验开始消息：包含实验基本信息、配置参数、开始时间
- 实验结束消息：包含实验结果摘要、最佳指标、SwanLab 链接、飞书文件夹链接

#### 2.1.2 API Bot 功能

**需求描述：**
- 负责将实验结果写入到飞书表格中
- 需要支持以下功能：
  - 创建实验文件夹和表格
  - 写入实验结果数据
  - 格式化表格（合并单元格、加粗最佳结果）
  - 版本控制和实验标注

**配置要求：**
- 需要提供 `app_id` 配置
- 需要提供 `app_secret` 配置
- 需要提供 `root_folder_token` 配置

**表格格式要求：**
- 一个 dataset 下面的多个 metric 需要对多个单元格合并
- 将该 dataset 下的 metric 下面的最好的 method 结果加粗
- 支持多数据集、多指标、多方法的复杂表格结构

**版本控制和标注：**
- 实验文件夹和文件名需要能见名知义
- 在根文件夹下新建不同的文件以标注实验类型
- 支持实验版本管理

### 2.2 SwanLab 实验配置、追踪和管理

#### 2.2.1 基础功能

**需求描述：**
- 在原来 SwanLab 的功能基础上拓展
- 需要保证对外的使用体验和原来的 SwanLab 一样
- 提供与 SwanLab 兼容的 API 接口

**配置要求：**
- SwanLab 需要可选的 `api_key` 配置
- 如果不提供 `api_key`，则默认使用系统的 SwanLab 账户

#### 2.2.2 兼容性支持

**需求描述：**
- 支持原来使用 TensorBoard 等工具的代码迁移
- 提供 TensorBoard 到 SwanLab 的适配器
- 支持常见的机器学习框架（PyTorch, TensorFlow 等）

### 2.3 本地日志和模型存储管理

#### 2.3.1 日志管理

**需求描述：**
- 支持本地日志存储
- 支持云端日志存储（通过 SwanLab 自动存储）
- 使用 loguru 进行日志记录，不使用 print

**日志级别：**
- DEBUG: 详细的调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息
- CRITICAL: 严重错误

#### 2.3.2 数据存储

**需求描述：**
- 实验数据 CSV 本地存储
- 实验数据 CSV 云端存储（飞书表格）
- 模型文件本地存储
- 支持实验数据的版本管理

## 3. 非功能需求

### 3.1 性能需求

- 消息通知延迟 < 5 秒
- 数据写入飞书表格延迟 < 10 秒
- 支持并发实验管理

### 3.2 可靠性需求

- 网络异常时自动重试
- 数据写入失败时提供错误提示
- 支持离线模式（仅本地存储）

### 3.3 可维护性需求

- 代码遵循 Google 开源项目规范
- 文档清晰，注释使用英文
- 使用 Google docstring 格式
- 支持单元测试

### 3.4 兼容性需求

- Python >= 3.9
- 支持主流操作系统（Linux, macOS, Windows）
- 兼容 SwanLab 最新版本

## 4. 技术约束

### 4.1 技术栈

- Python >= 3.9
- loguru: 日志记录
- swanlab: 实验追踪
- requests: HTTP 请求
- 其他依赖见 `pyproject.toml`

### 4.2 开发工具

- uv: 包管理和虚拟环境管理
- flake8: 代码风格检查
- isort: import 排序
- black: 代码格式化（可选）
- mypy: 类型检查（可选）

## 5. 数据模型

### 5.1 实验配置 Schema

详见 `docs/schema.md` 中的实验配置 Schema 定义。

### 5.2 实验数据 Schema

详见 `docs/schema.md` 中的实验数据格式定义。

## 6. 接口需求

### 6.1 核心接口

- `OwLab.init()`: 初始化 OwLab，配置飞书和 SwanLab
- `OwLab.start_experiment()`: 开始实验
- `OwLab.log()`: 记录实验指标
- `OwLab.finish_experiment()`: 结束实验并生成报告

### 6.2 飞书接口

- `LarkWebhookBot.send_notification()`: 发送消息通知
- `LarkAPIBot.create_folder()`: 创建文件夹
- `LarkAPIBot.write_results()`: 写入实验结果

### 6.3 SwanLab 接口

- `SwanLabTracker.init()`: 初始化追踪器
- `SwanLabTracker.log()`: 记录指标
- `SwanLabTracker.finish()`: 完成追踪

## 7. 错误处理

### 7.1 错误类型

- 配置错误：缺少必要的配置项
- 网络错误：无法连接到飞书或 SwanLab
- 数据错误：数据格式不符合 Schema
- 权限错误：API 权限不足

### 7.2 错误处理策略

- 提供清晰的错误消息
- 记录错误日志
- 支持错误重试机制

## 8. 未来扩展

### 8.1 计划功能

- 支持更多消息通知平台（企业微信、钉钉等）
- 支持更多实验追踪平台（MLflow、Weights & Biases 等）
- 支持实验对比分析
- 支持实验自动调参

### 8.2 性能优化

- 批量写入飞书表格
- 异步消息通知
- 缓存机制
